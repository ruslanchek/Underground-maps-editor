var config={text_idle_fill_color:"rgba(0, 0, 0, 1)",shape_idle_fill_color:"rgba(0, 0, 0, 0)",selected_color:"rgba(240, 0, 0, 1)",hover_color:"rgba(200, 0, 0, 1)",hover_selected_color:"rgba(220, 0, 0, 1)",bar_width:7,bar_height:7,bar_width_selected:7,bar_height_selected:7,end_width:19,end_height:7,end_width_selected:19,end_height_selected:7,circle_radius:7,circle_stroke_width:5,circle_stroke_width_selected:5},SText=function(t,e,o){function i(){var t=0,i=0,n=a.getBBox(),r=o.getBBox(),c=3;switch(e.text_side){case"top":t=r.cx-n.width/2+c,i=r.y-c-e.margin;break;case"right":t=r.x2+c+e.margin,i=r.cy+n.height/4;break;case"bottom":t=r.cx-n.width/2+c,i=r.y2+n.height-c+e.margin;break;case"left":t=r.x-n.width+3*c-e.margin,i=r.cy+n.height/4}return{x:t,y:i}}function n(){s=t.rect(0,0,0,0),s.attr({fill:"rgba(255, 255, 255, 0.75)",cursor:"pointer"})}function r(){var t=a.getBBox(),e=t.x-h,o=t.y-f,i=t.width+2*h,n=t.height+2*f;s.attr({x:e,y:o,width:i,height:n})}function c(){n(),a=t.text(0,0,e.name);var o=i();a.attr({x:o.x,y:o.y,fontSize:14,cursor:"pointer"}),r()}if(this.empty=!1,!e.name)return void(this.empty=!0);var l=this,a=null,s=null,h=2,f=0;this.getText=function(){return a},this.getBg=function(){return s},c()},SShape=function(t,e){function o(){var o=t.circle(e.x,e.y,config.circle_radius);return o.attr({fill:config.shape_idle_fill_color,stroke:e.color,strokeWidth:config.circle_stroke_width,cursor:"pointer"}),o}function i(){var o=t.rect(e.x,e.y,config.bar_width,config.bar_height);o.attr({fill:e.color,cursor:"pointer"});var i=(new Snap.Matrix).rotate(e.rotate,e.x+2,e.y+2);return o.transform(i),o}function n(){var o=t.rect(e.x,e.y,config.end_width,config.end_height);return o.attr({fill:e.color,cursor:"pointer"}),o}function r(){switch(e.type){case"circle":c=o();break;case"bar":c=i();break;case"end":c=n()}}var c=null;r(),this.getShape=function(){return c}},SStation=function(t,e,o){function i(t,e){t.attr(e)}function n(){switch(e.type){case"bar":return{fill:config.selected_color,width:config.bar_width,height:config.bar_height};break;case"end":return{fill:config.hover_color,width:config.end_width,height:config.end_height};break;case"circle":return{stroke:config.hover_color}}}function r(){switch(e.type){case"bar":return{fill:config.selected_color,width:config.bar_width_selected,height:config.bar_height_selected};break;case"end":return{fill:config.selected_color,width:config.end_width_selected,height:config.end_height_selected};break;case"circle":return{stroke:config.selected_color,fill:config.selected_color,strokeWidth:config.circle_stroke_width_selected}}}function c(){switch(e.type){case"bar":return{fill:config.hover_selected_color,width:config.bar_width_selected,height:config.bar_height_selected};break;case"end":return{fill:config.hover_selected_color,width:config.end_width_selected,height:config.end_height_selected};break;case"circle":return{stroke:config.hover_selected_color,fill:config.hover_selected_color,strokeWidth:config.circle_stroke_width_selected}}}function l(){switch(e.type){case"bar":return{fill:e.color,width:config.bar_width,height:config.bar_height};break;case"end":return{fill:e.color,width:config.end_width,height:config.end_height};break;case"circle":return{stroke:e.color,fill:config.shape_idle_fill_color,strokeWidth:config.circle_stroke_width}}}function a(t,e,o){d?(d=!1,e.attr(l()),i(o,{fill:config.text_idle_fill_color})):(d=!0,e.attr(r()),i(o,{fill:config.selected_color})),_.options.onClick(this)}function s(t,e,o){d?(e.attr(c()),o.attr({fill:config.hover_selected_color})):(e.attr(n()),i(o,{fill:config.hover_color})),_.options.onMouseOver(this)}function h(t,e,o){d?(e.attr(r()),o.attr({fill:config.selected_color})):(e.attr(l()),i(o,{fill:config.text_idle_fill_color})),_.options.onMouseOut(this)}function f(){var e=g.getShape(),o=null,i=null,n;u.empty?n=t.g(e):(i=u.getBg(),o=u.getText(),n=t.g(e,i,o)),n.hover(function(t){s(t,e,o)},function(t){h(t,e,o)}),n.click(function(t){a(t,e,o)})}var _=this,d=!1;e.x=parseFloat(e.x),e.y=parseFloat(e.y),e.width=parseInt(e.width),e.stroke_width=parseInt(e.stroke_width),e.rotate=parseInt(e.rotate),e.margin=parseInt(e.margin);var g=new SShape(t,e),u=new SText(t,e,g.getShape()),p=null;this.options=$.extend({onClick:function(t){},onMouseOver:function(t){},onMouseOut:function(t){}},o),this.isSelected=function(){return d},this.getData=function(){return e},f()},SMap=function(t){function e(){c.options.onLoad()}function o(){s=Snap(c.options.selector),Snap.load(c.options.map_svg,function(t){s.append(t),r(function(){s.zpd({zoom:!1,pan:!0,drag:!1}),i(function(){e()})})})}function i(t){t&&t()}function n(t){l.push(new SStation(s,t,{onClick:function(e){console.log(t)},onMouseOver:function(e){console.log(t)},onMouseOut:function(e){console.log(t)}}))}function r(t){$.ajax({url:c.options.data_url,type:"get",dataType:"json",success:function(e){for(var o=0;o<e.length;o++)n(e[o]);t&&t()}})}var c=this,l=[];this.options=$.extend({selector:"",map_svg:"",data_url:"",min_zoom:.75,max_zoom:1,zoom_animation_time:500,onLoad:function(){}},t);var a=$(this.options.selector),s=null;this.zoomOut=function(t){s.zoomTo(this.options.max_zoom,t?0:this.options.zoom_animation_time,mina.easeinout)},this.zoomIn=function(t){s.zoomTo(this.options.min_zoom,t?0:this.options.zoom_animation_time,mina.easeinout)},this.getStations=function(){return l},this.init=function(){o()}};$(function(){var t=new SMap({selector:"#map",map_svg:"img/moscow.svg",data_url:"moscow.json",min_zoom:.68});t.init(),$(".zoomer").on("click",function(e){e.preventDefault(),$(this).hasClass("active")?($(this).removeClass("active"),t.zoomIn()):($(this).addClass("active"),t.zoomOut())})});
var config={text_idle_fill_color:"rgba(0, 0, 0, 1)",shape_idle_fill_color:"rgba(0, 0, 0, 0)",selected_color:"rgba(240, 0, 0, 1)",hover_color:"rgba(200, 0, 0, 1)",hover_selected_color:"rgba(220, 0, 0, 1)",bar_width:7,bar_height:7,bar_width_selected:7,bar_height_selected:7,end_width:19,end_height:7,end_width_selected:19,end_height_selected:7,circle_radius:7,circle_stroke_width:5,circle_stroke_width_selected:5},SText=function(t,e,o){function n(){var t=0,n=0,i=l.getBBox(),c=o.getBBox(),r=3;switch(e.text_side){case"top":t=c.cx-i.width/2+r,n=c.y-r-e.margin;break;case"right":t=c.x2+r+e.margin,n=c.cy+i.height/4;break;case"bottom":t=c.cx-i.width/2+r,n=c.y2+i.height-r+e.margin;break;case"left":t=c.x-i.width+3*r-e.margin,n=c.cy+i.height/4}return{x:t,y:n}}function i(){s=t.rect(0,0,0,0),s.attr({fill:"rgba(255, 255, 255, 0.75)",cursor:"pointer"})}function c(){var t=l.getBBox(),e=t.x-h,o=t.y-f,n=t.width+2*h,i=t.height+2*f;s.attr({x:e,y:o,width:n,height:i})}function r(){i(),l=t.text(0,0,e.name);var o=n();l.attr({x:o.x,y:o.y,fontSize:14,cursor:"pointer"}),c()}if(this.empty=!1,!e.name)return void(this.empty=!0);var a=this,l=null,s=null,h=2,f=0;this.getText=function(){return l},this.getBg=function(){return s},r()},SShape=function(t,e){function o(){var o=t.circle(e.x,e.y,config.circle_radius);return o.attr({fill:config.shape_idle_fill_color,stroke:e.color,strokeWidth:config.circle_stroke_width,cursor:"pointer"}),o}function n(){var o=t.rect(e.x,e.y,config.bar_width,config.bar_height);o.attr({fill:e.color,cursor:"pointer"});var n=(new Snap.Matrix).rotate(e.rotate,e.x+2,e.y+2);return o.transform(n),o}function i(){var o=t.rect(e.x,e.y,config.end_width,config.end_height);return o.attr({fill:e.color,cursor:"pointer"}),o}function c(){switch(e.type){case"circle":r=o();break;case"bar":r=n();break;case"end":r=i()}}var r=null;c(),this.getShape=function(){return r}},SStation=function(t,e,o,n){function i(t,e){t.attr(e)}function c(){switch(e.type){case"bar":return{fill:config.selected_color,width:config.bar_width,height:config.bar_height};break;case"end":return{fill:config.hover_color,width:config.end_width,height:config.end_height};break;case"circle":return{stroke:config.hover_color}}}function r(){switch(e.type){case"bar":return{fill:config.selected_color,width:config.bar_width_selected,height:config.bar_height_selected};break;case"end":return{fill:config.selected_color,width:config.end_width_selected,height:config.end_height_selected};break;case"circle":return{stroke:config.selected_color,fill:config.selected_color,strokeWidth:config.circle_stroke_width_selected}}}function a(){switch(e.type){case"bar":return{fill:config.hover_selected_color,width:config.bar_width_selected,height:config.bar_height_selected};break;case"end":return{fill:config.hover_selected_color,width:config.end_width_selected,height:config.end_height_selected};break;case"circle":return{stroke:config.hover_selected_color,fill:config.hover_selected_color,strokeWidth:config.circle_stroke_width_selected}}}function l(){switch(e.type){case"bar":return{fill:e.color,width:config.bar_width,height:config.bar_height};break;case"end":return{fill:e.color,width:config.end_width,height:config.end_height};break;case"circle":return{stroke:e.color,fill:config.shape_idle_fill_color,strokeWidth:config.circle_stroke_width}}}function s(t,e){_=!0,t.attr(r()),i(e,{fill:config.selected_color}),g.selectBinded(),g.options.onSelect(g)}function h(t,e){_=!1,t.attr(l()),i(e,{fill:config.text_idle_fill_color}),g.unselectBinded(),g.options.onUnselect(g)}function f(t,e){_?(t.attr(a()),e.attr({fill:config.hover_selected_color})):(t.attr(c()),i(e,{fill:config.hover_color})),g.options.onMouseOver(g)}function u(t,e){_?(t.attr(r()),e.attr({fill:config.selected_color})):(t.attr(l()),i(e,{fill:config.text_idle_fill_color})),g.options.onMouseOut(g)}function d(){w=p.getShape(),v.empty?m=t.g(w):(S=v.getBg(),b=v.getText(),m=t.g(w,S,b)),m.hover(function(){f(w,b)},function(){u(w,b)}),m.click(function(){_?h(w,b):s(w,b),g.options.onClick(g)})}var g=this,_=!1;e.x=parseFloat(e.x),e.y=parseFloat(e.y),e.width=parseInt(e.width),e.stroke_width=parseInt(e.stroke_width),e.rotate=parseInt(e.rotate),e.margin=parseInt(e.margin);var p=new SShape(t,e),v=new SText(t,e,p.getShape()),m=null,w=null,b=null,S=null;this.options=$.extend({onClick:function(t){},onSelect:function(t){},onUnselect:function(t){},onMouseOver:function(t){},onMouseOut:function(t){}},o),this.selectBinded=function(){if(e.bind)for(var t=0;t<e.bind.length;t++){var o=e.bind[t],i=n.getStationById(o);i&&!i.isSelected()&&i.select()}},this.unselectBinded=function(){if(e.bind)for(var t=0;t<e.bind.length;t++){var o=e.bind[t],i=n.getStationById(o);i&&i.isSelected()&&i.unselect()}},this.select=function(){_||s(w,b)},this.unselect=function(){_&&h(w,b)},this.isSelected=function(){return _},this.getData=function(){return e},d()},SMap=function(t){function e(){r.options.onLoad()}function o(){s=Snap(r.options.selector),Snap.load(r.options.map_svg,function(t){s.append(t),c(function(){s.zpd({zoom:!1,pan:!0,drag:!1}),n(function(){e()})})})}function n(t){t&&t()}function i(t){a.push(new SStation(s,t,{onMouseOver:function(t){r.options.onStationMouseOver(t)},onMouseOut:function(t){r.options.onStationMouseOut(t)},onSelect:function(t){r.options.onStationSelect(t)},onUnselect:function(t){r.options.onStationUnselect(t)},onClick:function(t){r.options.onStationClick(t)}},r))}function c(t){$.ajax({url:r.options.data_url,type:"get",dataType:"json",success:function(e){for(var o=0;o<e.length;o++)i(e[o]);t&&t()}})}var r=this,a=[];this.options=$.extend({selector:"",map_svg:"",data_url:"",min_zoom:.75,max_zoom:1,zoom_animation_time:500,onLoad:function(){},onStationClick:function(t){},onStationMouseOver:function(t){},onStationMouseOut:function(t){},onStationSelect:function(t){},onStationUnselect:function(t){}},t);var l=$(this.options.selector),s=null;this.zoomOut=function(t){s.zoomTo(this.options.max_zoom,t?0:this.options.zoom_animation_time,mina.easeinout)},this.zoomIn=function(t){s.zoomTo(this.options.min_zoom,t?0:this.options.zoom_animation_time,mina.easeinout)},this.getStations=function(){return a},this.getStationById=function(t){for(var e=0;e<a.length;e++){var o=a[e];if(o.getData().id==t)return o}},this.init=function(){o()}};$(function(){function t(t){for(var e=[],i=0;i<o.length;i++){var c=o[i];c.id!=t.id&&e.push(c)}o=e,n.set("stations",o)}function e(t){for(var e=!1,i=0;i<o.length;i++){var c=o[i];c.id==t.id&&(e=!0)}e||o.push(t),n.set("stations",o)}var o=[],n=new Ractive({el:"#stations",template:"#template",data:{stations:o}}),i=new SMap({selector:"#map",map_svg:"img/moscow.svg",data_url:"moscow.json",min_zoom:.68,onStationSelect:function(t){e(t.getData())},onStationUnselect:function(e){t(e.getData())}});i.init(),$(".zoomer").on("click",function(t){t.preventDefault(),$(this).hasClass("active")?($(this).removeClass("active"),i.zoomIn()):($(this).addClass("active"),i.zoomOut())})});
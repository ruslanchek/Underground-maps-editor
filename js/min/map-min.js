var iMap={};iMap.config={text_idle_fill_color:"rgba(120, 120, 120, 1)",text_idle_fill_hover_color:"rgba(80, 80, 80, 1)",text_selected_color:"rgba(0, 0, 0, 1)",text_selected_color_hover:"rgba(40, 40, 40, 1)",shape_idle_fill_color:"rgba(255, 255, 255, 1)",selected_color:"rgba(255, 0, 0, 1)",hover_color:"rgba(255, 0, 0, 1)",hover_selected_color:"rgba(0, 0, 0, 0)",bar_width:7,bar_height:7,bar_width_selected:7,bar_height_selected:7,end_width:21,end_height:7,end_width_selected:21,end_height_selected:7,circle_radius:7,circle_stroke_width:5,circle_stroke_width_selected:5},iMap.Map=function(t){function i(t){a.initialized=!0,h=Snap("#"+a.options.target_id+"-svg"),Snap.load(a.options.map_svg,function(i){h.append(i),c(function(){h.zpd({zoom:!1,pan:!0,drag:!1}),e(function(){a.options.onLoad(a),$(".map-loading-overlay").addClass("hidden"),setTimeout(function(){$(".map-loading-overlay").remove()},300),t&&t()})})})}function e(t){t&&t(),h.zoomTo(a.options.min_zoom,0,mina.easeinout,function(){},{vp_w:a.options.viewport_width,vp_h:a.options.viewport_height,c_w:a.options.map_width,c_h:a.options.map_height,offset_x:a.options.offset_x,offset_y:a.options.offset_y})}function o(t){var i=new iMap.Station(h,t,{on_click_enabled:a.options.station_on_click_enabled,onMouseOver:function(t){a.options.onStationMouseOver(t,h)},onMouseOut:function(t){a.options.onStationMouseOut(t,h)},onSelect:function(t,i){a.options.onStationSelect(t,h,i)},onUnselect:function(t,i){a.options.onStationUnselect(t,h,i)},onClick:function(t){a.options.onStationClick(t,h)},onDblClick:function(t){a.options.onStationDblClick(t,h)}},a);r.push(i)}function n(t){var i=new iMap.LineButton(h,a,t);s.push(i)}function c(t){$.ajax({url:a.options.data_url,type:"get",dataType:"json",success:function(i){for(var e=0;e<i.stations.length;e++)o(i.stations[e]);for(var e=0;e<i.selectors.length;e++)n(i.selectors[e]);t&&t()}})}var a=this,r=[],s=[];this.options=$.extend({target_id:"",map_svg:"",data_url:"",min_zoom:.75,viewport_width:!1,viewport_height:!1,map_width:!1,map_height:!1,offset_x:!1,offset_y:!1,max_zoom:1,zoom_animation_time:300,station_on_click_enabled:!0,onLoad:function(){},onStationClick:function(t,i){},onStationMouseOver:function(t,i){},onStationMouseOut:function(t,i){},onStationSelect:function(t,i,e){},onStationUnselect:function(t,i,e){},onStationDblClick:function(t,i){}},t),this.initialized=!1,this.wrapper=!1;var l=$("#"+this.options.target_id),h=null;this.drawWraps=function(){l.html('<div class="map-loading-overlay"></div><a href="#" class="zoomer" id="'+a.options.target_id+'-zoomer"><i class="icon-font icon-font-zoom_in"></i></a><svg id="'+a.options.target_id+'-svg"></svg>');var t=$("#"+a.options.target_id+", #"+a.options.target_id+"-svg");$("#"+a.options.target_id+"-zoomer").on("click",function(t){t.preventDefault(),$(this).hasClass("active")?($(this).removeClass("active"),$(this).find(".icon-font").removeClass("icon-font-zoom_out").addClass("icon-font-zoom_in"),a.zoomIn()):($(this).addClass("active"),$(this).find(".icon-font").removeClass("icon-font-zoom_in").addClass("icon-font-zoom_out"),a.zoomOut())}),a.options.viewport_width&&a.options.viewport_height&&t.css({width:a.options.viewport_width,height:a.options.viewport_height}),this.wrapper=!0},this.zoomOut=function(t){h.zoomTo(this.options.max_zoom,t?0:this.options.zoom_animation_time,mina.easeinout,function(){},{vp_w:a.options.viewport_width,vp_h:a.options.viewport_height,c_w:a.options.map_width,c_h:a.options.map_height,offset_x:a.options.offset_x,offset_y:a.options.offset_y})},this.zoomIn=function(t){h.zoomTo(this.options.min_zoom,t?0:this.options.zoom_animation_time,mina.easeinout,function(){},{vp_w:a.options.viewport_width,vp_h:a.options.viewport_height,c_w:a.options.map_width,c_h:a.options.map_height,offset_x:a.options.offset_x,offset_y:a.options.offset_y})},this.getStations=function(){return r},this.getStationById=function(t){for(var i=0;i<r.length;i++){var e=r[i];if(e.getData().id==t)return e}},this.unselectAllStations=function(){for(var t=0;t<r.length;t++)r[t].unselect()},this.iterateAllStations=function(t){for(var i=0;i<r.length;i++)t&&t(r[i])},this.getSelectedStations=function(){for(var t=[],i=0;i<r.length;i++)r[i].isSelected()===!0&&t.push(r[i]);return t},this.selectStationById=function(t){var i=this.getStationById(t);i&&i.select()},this.unselectStationById=function(t){var i=this.getStationById(t);i&&i.unselect()},this.init=function(t){i(t)},this.getSnapInstance=function(){return h}},iMap.Shape=function(t,i){function e(){var e=t.circle(i.x,i.y,iMap.config.circle_radius);return e.attr({fill:iMap.config.shape_idle_fill_color,stroke:i.color,strokeWidth:iMap.config.circle_stroke_width,cursor:"pointer"}),e}function o(){var e=t.rect(i.x,i.y,iMap.config.bar_width,iMap.config.bar_height);return e.attr({fill:i.color,cursor:"pointer"}),e}function n(){var e=t.rect(i.x,i.y,iMap.config.end_width,iMap.config.end_height);return e.attr({fill:i.color,cursor:"pointer"}),e}function c(){switch(i.type){case"circle":r=e();break;case"bar":r=o();break;case"end":r=n()}}var a=this,r=null;this.rotate=function(t,i,e){var o=r.getBBox(),n=o.cx,c=o.cy;if(i===!0)r.animate({transform:"r"+t+","+n+","+c},200,function(){e&&e()});else{var a=(new Snap.Matrix).rotate(t,n,c);r.transform(a)}},this.getShape=function(){return r},c(),a.rotate(i.rotate)},iMap.Station=function(t,i,e,o){function n(t,i){t&&t.attr(i)}function c(t,i){t=String(t).replace(/[^0-9a-f]/gi,""),t.length<6&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]),i=i||0;var e="#",o,n;for(n=0;3>n;n++)o=parseInt(t.substr(2*n,2),16),o=Math.round(Math.min(Math.max(0,o+o*i),255)).toString(16),e+=("00"+o).substr(o.length);return e}function a(){switch(i.type){case"bar":return{fill:c(i.color,-.25),width:iMap.config.bar_width,height:iMap.config.bar_height};break;case"end":return{fill:c(i.color,-.25),width:iMap.config.end_width,height:iMap.config.end_height};break;case"circle":return{stroke:c(i.color,-.25)}}}function r(){switch(i.type){case"bar":return{fill:iMap.config.selected_color,width:iMap.config.bar_width_selected,height:iMap.config.bar_height_selected};break;case"end":return{fill:iMap.config.selected_color,width:iMap.config.end_width_selected,height:iMap.config.end_height_selected};break;case"circle":return{stroke:iMap.config.selected_color,fill:iMap.config.selected_color,strokeWidth:iMap.config.circle_stroke_width_selected}}}function s(){switch(i.type){case"bar":return{fill:iMap.config.hover_selected_color,width:iMap.config.bar_width_selected,height:iMap.config.bar_height_selected};break;case"end":return{fill:iMap.config.hover_selected_color,width:iMap.config.end_width_selected,height:iMap.config.end_height_selected};break;case"circle":return{stroke:iMap.config.hover_selected_color,fill:iMap.config.hover_selected_color,strokeWidth:iMap.config.circle_stroke_width_selected}}}function l(){switch(i.type){case"bar":return{fill:i.color,width:iMap.config.bar_width,height:iMap.config.bar_height};break;case"end":return{fill:i.color,width:iMap.config.end_width,height:iMap.config.end_height};break;case"circle":return{stroke:i.color,fill:iMap.config.shape_idle_fill_color,strokeWidth:iMap.config.circle_stroke_width}}}function h(t,i,e){v=!0,t.attr(r()),n(i,{fill:iMap.config.text_selected_color}),g.selectBinded(),g.options.onSelect(g,e),g.selected.show()}function f(t,i,e){v=!1,t.attr(l()),n(i,{fill:iMap.config.text_idle_fill_color}),g.unselectBinded(),g.options.onUnselect(g,!1),g.selected.hide()}function d(t,i){v?(t.attr(s()),i.attr({fill:iMap.config.text_selected_color_hover})):(t.attr(a()),n(i,{fill:iMap.config.text_idle_fill_hover_color})),g.options.onMouseOver(g)}function _(t,i){v?(t.attr(r()),i.attr({fill:iMap.config.text_selected_color})):(t.attr(l()),n(i,{fill:iMap.config.text_idle_fill_color})),g.options.onMouseOut(g)}function p(e){var o=e.getBBox().cx,n=e.getBBox().cy,c=iMap.config.bar_width;"bar"==i.type&&0==i.rotate&&("right"==i.text_side&&(o-=c),"left"==i.text_side&&(o+=c),"top"==i.text_side&&(n+=c),"bottom"==i.text_side&&(n-=c)),"bar"!=i.type||45!=i.rotate&&-45!=i.rotate||("right"==i.text_side&&(o-=1.5*c),"left"==i.text_side&&(o+=1.5*c));var a=t.circle(o,n,iMap.config.circle_radius+iMap.config.circle_stroke_width-1),r=Snap.parsePathString("M13.5,15.5c-0.266,0-0.52-0.105-0.707-0.293l-3.141-3.141c-0.391-0.391-0.391-1.023,0-1.414s1.023-0.391,1.414,0l2.434,2.434l4.391-4.392c0.391-0.391,1.023-0.391,1.414,0s0.391,1.023,0,1.414l-5.098,5.099C14.02,15.395,13.766,15.5,13.5,15.5z"),s=t.path(r);s.transform("translate("+(o-14)+","+(n-12)+")"),this.shape=t.group(a,s),s.attr({fill:"#fff",cursor:"pointer"}),a.attr({fill:"#4C4C4C",cursor:"pointer"}),this.shape.attr({opacity:0}),this.show=function(){this.shape.attr({opacity:0})},this.hide=function(){this.shape.attr({opacity:0})}}function u(){x=w.getShape(),S=m.getBg(),b=m.getText(),g.selected=new p(x),M=t.g(x,S,b,g.selected.shape),M.attr({id:"station-"+i.id}),M.hover(function(){d(x,b)},function(){_(x,b)}),g.options.on_click_enabled===!0&&M.click(function(){v?f(x,b):h(x,b),g.options.onClick(g)}),M.dblclick(function(){g.options.onDblClick(g)})}var g=this,v=!1;i.x=parseFloat(i.x),i.y=parseFloat(i.y),i.rotate=parseInt(i.rotate),i.margin=parseInt(i.margin);var w=new iMap.Shape(t,i),m=new iMap.Text(t,i,w.getShape()),M=null,x=null,b=null,S=null;this.options=$.extend({on_click_enabled:!0,onClick:function(t){},onSelect:function(t,i){},onUnselect:function(t,i){},onMouseOver:function(t){},onMouseOut:function(t){},onDblClick:function(t){}},e),this.selectBinded=function(){if(i.bind)for(var t=0;t<i.bind.length;t++){var e=i.bind[t],n=o.getStationById(e);n&&!n.isSelected()&&n.select(!0)}},this.unselectBinded=function(){if(i.bind)for(var t=0;t<i.bind.length;t++){var e=i.bind[t],n=o.getStationById(e);n&&n.isSelected()&&n.unselect(!0)}},this.select=function(t){v||h(x,b,t)},this.unselect=function(t){v&&f(x,b,t)},this.isSelected=function(){return v},this.getData=function(){return i},this.getGroup=function(){return M},this.setDataParam=function(t,e){i[t]=e},this.getDataParam=function(t){return i[t]},this.extractSVG=function(){var t=this.getGroup();return t.outerSVG()},this.renewData=function(){m.changeText(i),x.attr(this.isSelected()?r():l()),w.rotate(i.rotate,!0,function(){m.changeText(i)})},u(),i.selected&&this.select()},iMap.Text=function(t,i,e){function o(){var t=0,o=0,n=s.getBBox(),c=e.getBBox(),a=3;switch(i.text_side){case"top":t=c.cx-n.width/2,o=c.y-i.margin;break;case"right":t=c.x2+i.margin,o=c.cy+n.height/2-a;break;case"bottom":t=c.cx-n.width/2,o=c.y2+n.height+i.margin-a;break;case"left":t=c.x-n.width-i.margin-a,o=c.cy+n.height/2-a}return{x:t,y:o}}function n(){l=t.rect(0,0,0,0),l.attr({fill:"rgba(255, 255, 255, 0.75)",cursor:"pointer"})}function c(){var t=s.getBBox(),i=t.x-h,e=t.y-f,o=t.width+2*h,n=t.height+2*f;l.attr({x:i,y:e,width:o,height:n})}function a(){n(),s=Snap("svg").multitext(0,0,i.name),s.attr({fill:iMap.config.text_idle_fill_color,fontSize:15,cursor:"pointer"}),r.changeText(i)}var r=this,s=null,l=null,h=2,f=0;this.getText=function(){return s},this.getBg=function(){return l},this.changeText=function(t){var i=o();s.transform("t"+i.x+","+i.y),c()},a()},iMap.LineButton=function(t,i,e){var o,n,c,a,r=function(){o=t.rect(e.x,e.y,iMap.config.end_width,iMap.config.end_width,3),o.attr({fill:e.color}),n=t.text(e.x,e.y,e.name);var r=e.x+iMap.config.end_width/2,s=e.y+16;r-=n.getBBox().width/2,n.attr({x:r,y:s}),n.attr({fill:"#fff"}),e.title&&(a=t.text(e.x+30,s,e.title)),c=e.title?t.g(o,n,a):t.g(o,n),c.attr({cursor:"pointer"}),c.click(function(){if(e.select){for(var t=[],o=[],n=0,c=e.select.length;c>n;n++){var a=i.getStationById(e.select[n]);a&&(a.isSelected()?t.push(e.select[n]):o.push(e.select[n]))}if(e.select.length==t.length)for(var n=0,c=e.select.length;c>n;n++){var a=i.getStationById(e.select[n]);a&&a.unselect()}else for(var n=0,c=e.select.length;c>n;n++){var a=i.getStationById(e.select[n]);a&&a.select()}}})};r()};
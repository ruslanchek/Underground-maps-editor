var SText=function(t,o,n){function i(){var t=0,i=0,e=c.getBBox(),r=n.getBBox(),a=3;switch(o.text_side){case"top":t=r.cx-e.width/2+a,i=r.y-a-o.margin;break;case"right":t=r.x2+a+o.margin,i=r.cy+e.height/4;break;case"bottom":t=r.cx-e.width/2+a,i=r.y2+e.height-a+o.margin;break;case"left":t=r.x-e.width+3*a-o.margin,i=r.cy+e.height/4}return{x:t,y:i}}function e(){u=t.rect(0,0,0,0),u.attr({fill:"rgba(255, 255, 255, 0.75)",cursor:"pointer"})}function r(){var t=c.getBBox(),o=t.x-h,n=t.y-l,i=t.width+2*h,e=t.height+2*l;u.attr({x:o,y:n,width:i,height:e})}function a(){e(),c=t.text(0,0,o.name);var n=i();c.attr({x:n.x,y:n.y,fontSize:14,cursor:"pointer"}),r()}var s=this,c=null,u=null,h=2,l=0;this.getText=function(){return u},this.getBg=function(){return u},a()},SShape=function(t,o){function n(){var n=t.circle(o.x,o.y,2*o.width-1);return n.attr({fill:"rgba(0,0,0,0)",stroke:o.color,strokeWidth:o.stroke_width+1,cursor:"pointer"}),n}function i(){var n=t.rect(o.x,o.y,o.width,4);n.attr({fill:o.color,stroke:o.color,strokeWidth:4,cursor:"pointer"});var i=(new Snap.Matrix).rotate(o.rotate,o.x+2,o.y+2);return n.transform(i),n}function e(){var n=t.circle(o.x,o.y,2*o.width-1);return n.attr({fill:"rgba(0,0,0,0)",stroke:o.color,strokeWidth:o.stroke_width+1,cursor:"pointer"}),n}function r(){switch(o.type){case"circle":a=n();break;case"bar":a=i();break;case"end":a=e()}}var a=null;r(),this.getShape=function(){return a}},SStation=function(t,o,n){function i(){switch(o.type){case"bar":case"end":return{fill:"red",stroke:"red"};break;case"circle":return{stroke:"red"}}}function e(){switch(o.type){case"bar":case"end":return{fill:o.color,stroke:o.color};break;case"circle":return{stroke:o.color}}}function r(){var n=s.getShape(),r=c.getText(),h=c.getBg();u=t.g(h,n,r),u.hover(function(t){a.options.onMouseOver(t,o),n.animate(i(),100)},function(t){a.options.onMouseOut(t,o),n.animate(e(),100)}),u.click(function(t){a.options.onClick(t,o)})}var a=this;o.x=parseFloat(o.x),o.y=parseFloat(o.y),o.width=parseInt(o.width),o.stroke_width=parseInt(o.stroke_width),o.rotate=parseInt(o.rotate),o.margin=parseInt(o.margin);var s=new SShape(t,o),c=new SText(t,o,s.getShape()),u=null;this.options=$.extend({onClick:function(t,o){},onMouseOver:function(t,o){},onMouseOut:function(t,o){}},n),r()},SMap=function(t){function o(){a.options.onLoad()}function n(){l=Snap(a.options.selector),Snap.load(a.options.map_svg,function(t){l.append(t),e(function(){l.zpd({zoom:!1,pan:!0,drag:!1}),r(function(){o()})})})}function i(t){s.push(new SStation(l,t))}function e(t){$.ajax({url:a.options.data_url,type:"get",dataType:"json",success:function(o){for(var n=0;n<o.length;n++)i(o[n]);t&&t()}})}function r(t){t&&t()}var a=this,s=[];this.options=$.extend({selector:"",map_svg:"",data_url:"",min_zoom:.75,max_zoom:1,zoom_animation_time:500,onLoad:function(){}},t);var c=$(this.options.selector),u=c.width(),h=c.height(),l=null;this.zoomOut=function(t){l.zoomTo(this.options.max_zoom,t?0:this.options.zoom_animation_time,mina.easeinout)},this.zoomIn=function(t){l.zoomTo(this.options.min_zoom,t?0:this.options.zoom_animation_time,mina.easeinout)},this.init=function(){n()}};$(function(){var t=new SMap({selector:"#map",map_svg:"img/moscow.svg",data_url:"moscow.json",min_zoom:.68});t.init(),$(".zoomer").on("click",function(o){o.preventDefault(),$(this).hasClass("active")?($(this).removeClass("active"),t.zoomIn()):($(this).addClass("active"),t.zoomOut())})});
var iMap={};iMap.config={text_idle_fill_color:"rgba(0, 0, 0, 1)",shape_idle_fill_color:"rgba(255, 255, 255, 1)",selected_color:"rgba(240, 0, 0, 1)",hover_color:"rgba(200, 0, 0, 1)",hover_selected_color:"rgba(220, 0, 0, 1)",bar_width:7,bar_height:7,bar_width_selected:7,bar_height_selected:7,end_width:21,end_height:7,end_width_selected:21,end_height_selected:7,circle_radius:7,circle_stroke_width:5,circle_stroke_width_selected:5},iMap.Map=function(t){function i(t){a.initialized=!0,s=Snap("#"+a.options.target_id+"-svg"),Snap.load(a.options.map_svg,function(i){s.append(i),o(function(){s.zpd({zoom:!1,pan:!0,drag:!1}),n(function(){a.options.onLoad(),$(".map-loading-overlay").addClass("hidden"),setTimeout(function(){$(".map-loading-overlay").remove()},300),t&&t()})})})}function n(t){t&&t(),s.zoomTo(a.options.min_zoom,0,mina.easeinout,function(){})}function e(t,i){c.push(new iMap.Station(s,t,{on_click_enabled:a.options.station_on_click_enabled,onMouseOver:function(t){a.options.onStationMouseOver(t,s)},onMouseOut:function(t){a.options.onStationMouseOut(t,s)},onSelect:function(t,i){a.options.onStationSelect(t,s,i)},onUnselect:function(t,i){a.options.onStationUnselect(t,s,i)},onClick:function(t){a.options.onStationClick(t,s)},onDblClick:function(t){a.options.onStationDblClick(t,s)}},a))}function o(t){$.ajax({url:a.options.data_url,type:"get",dataType:"json",success:function(i){for(var n=0;n<i.length;n++)e(i[n],n);t&&t()}})}var a=this,c=[];this.options=$.extend({target_id:"",map_svg:"",data_url:"",min_zoom:.75,viewport_width:!1,viewport_height:!1,max_zoom:1,zoom_animation_time:300,station_on_click_enabled:!0,onLoad:function(){},onStationClick:function(t,i){},onStationMouseOver:function(t,i){},onStationMouseOut:function(t,i){},onStationSelect:function(t,i,n){},onStationUnselect:function(t,i,n){},onStationDblClick:function(t,i){}},t),this.initialized=!1,this.wrapper=!1;var r=$("#"+this.options.target_id),s=null;this.drawWraps=function(){var t='<div class="map-transport-times">До станции <a class="type-selector link-dotted" href="#"><span class="dotted">пешком</span></a><span class="time"><i class="icon-font unactive icon-font-arr-left"></i><span>10 мин</span><i class="icon-font icon-font-arr-right"></i></span></div>',i=["пешком","на машине"],n=[10,15,20],e=0;r.html('<div class="map-loading-overlay"></div>'+t+'<a href="#" class="zoomer" id="'+a.options.target_id+'-zoomer"><i class="icon-font icon-font-zoom_in"></i></a><svg id="'+a.options.target_id+'-svg"></svg>');var o=$("#"+a.options.target_id+", #"+a.options.target_id+"-svg");$("#"+a.options.target_id+"-zoomer").on("click",function(t){t.preventDefault(),$(this).hasClass("active")?($(this).removeClass("active"),$(this).find(".icon-font").removeClass("icon-font-zoom_out").addClass("icon-font-zoom_in"),a.zoomIn()):($(this).addClass("active"),$(this).find(".icon-font").removeClass("icon-font-zoom_in").addClass("icon-font-zoom_out"),a.zoomOut())}),a.options.viewport_width&&a.options.viewport_height&&o.css({width:a.options.viewport_width,height:a.options.viewport_height});var c=$(".map-transport-times");c.find(".type-selector").on("click",function(t){t.preventDefault();var n=$(this).find("span").text(),e=$.inArray(n,i),o=0;e>-1&&(o=e+1,o>i.length-1&&(o=0)),$(this).find("span").text(i[o])}),c.find(".icon-font").on("click",function(t){t.preventDefault(),$(this).hasClass("icon-font-arr-left")?0>e-1?e=0:e--:e+1>n.length-1?e=n.length-1:e++,e==n.length-1?$(".icon-font-arr-right").addClass("unactive"):$(".icon-font-arr-right").removeClass("unactive"),0==e?$(".icon-font-arr-left").addClass("unactive"):$(".icon-font-arr-left").removeClass("unactive"),c.find(".time > span").text(n[e]+" мин")}),this.wrapper=!0},this.zoomOut=function(t){s.zoomTo(this.options.max_zoom,t?0:this.options.zoom_animation_time,mina.easeinout,function(){})},this.zoomIn=function(t){s.zoomTo(this.options.min_zoom,t?0:this.options.zoom_animation_time,mina.easeinout,function(){})},this.getStations=function(){return c},this.getStationById=function(t){for(var i=0;i<c.length;i++){var n=c[i];if(n.getData().id==t)return n}},this.unselectAllStations=function(){for(var t=0;t<c.length;t++)c[t].unselect()},this.iterateAllStations=function(t){for(var i=0;i<c.length;i++)t&&t(c[i])},this.getSelectedStations=function(){for(var t=[],i=0;i<c.length;i++)c[i].getDataParam("selected")===!0&&t.push(c[i]);return t},this.selectStationById=function(t){var i=this.getStationById(t);i&&i.select()},this.unselectStationById=function(t){var i=this.getStationById(t);i&&i.unselect()},this.init=function(t){i(t)},this.getSnapInstance=function(){return s}},iMap.Shape=function(t,i){function n(){var n=t.circle(i.x,i.y,iMap.config.circle_radius);return n.attr({fill:iMap.config.shape_idle_fill_color,stroke:i.color,strokeWidth:iMap.config.circle_stroke_width,cursor:"pointer"}),n}function e(){var n=t.rect(i.x,i.y,iMap.config.bar_width,iMap.config.bar_height);return n.attr({fill:i.color,cursor:"pointer"}),n}function o(){var n=t.rect(i.x,i.y,iMap.config.end_width,iMap.config.end_height);return n.attr({fill:i.color,cursor:"pointer"}),n}function a(){switch(i.type){case"circle":r=n();break;case"bar":r=e();break;case"end":r=o()}}var c=this,r=null;this.rotate=function(t,i,n){var e=r.getBBox(),o=e.cx,a=e.cy;if(i===!0)r.animate({transform:"r"+t+","+o+","+a},200,function(){n&&n()});else{var c=(new Snap.Matrix).rotate(t,o,a);r.transform(c)}},this.getShape=function(){return r},a(),c.rotate(i.rotate)},iMap.Station=function(t,i,n,e){function o(t,i){t&&t.attr(i)}function a(t,i){t=String(t).replace(/[^0-9a-f]/gi,""),t.length<6&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]),i=i||0;var n="#",e,o;for(o=0;3>o;o++)e=parseInt(t.substr(2*o,2),16),e=Math.round(Math.min(Math.max(0,e+e*i),255)).toString(16),n+=("00"+e).substr(e.length);return n}function c(){switch(i.type){case"bar":return{fill:a(i.color,-.25),width:iMap.config.bar_width,height:iMap.config.bar_height};break;case"end":return{fill:a(i.color,-.25),width:iMap.config.end_width,height:iMap.config.end_height};break;case"circle":return{stroke:a(i.color,-.25)}}}function r(){switch(i.type){case"bar":return{fill:iMap.config.selected_color,width:iMap.config.bar_width_selected,height:iMap.config.bar_height_selected};break;case"end":return{fill:iMap.config.selected_color,width:iMap.config.end_width_selected,height:iMap.config.end_height_selected};break;case"circle":return{stroke:iMap.config.selected_color,fill:iMap.config.selected_color,strokeWidth:iMap.config.circle_stroke_width_selected}}}function s(){switch(i.type){case"bar":return{fill:iMap.config.hover_selected_color,width:iMap.config.bar_width_selected,height:iMap.config.bar_height_selected};break;case"end":return{fill:iMap.config.hover_selected_color,width:iMap.config.end_width_selected,height:iMap.config.end_height_selected};break;case"circle":return{stroke:iMap.config.hover_selected_color,fill:iMap.config.hover_selected_color,strokeWidth:iMap.config.circle_stroke_width_selected}}}function l(){switch(i.type){case"bar":return{fill:i.color,width:iMap.config.bar_width,height:iMap.config.bar_height};break;case"end":return{fill:i.color,width:iMap.config.end_width,height:iMap.config.end_height};break;case"circle":return{stroke:i.color,fill:iMap.config.shape_idle_fill_color,strokeWidth:iMap.config.circle_stroke_width}}}function f(t,i,n){_=!0,t.attr(r()),o(i,{fill:iMap.config.selected_color}),g.selectBinded(),g.options.onSelect(g,n)}function h(t,i,n){_=!1,t.attr(l()),o(i,{fill:iMap.config.text_idle_fill_color}),g.unselectBinded(),g.options.onUnselect(g,!1)}function d(t,i){_?(t.attr(s()),i.attr({fill:iMap.config.hover_selected_color})):(t.attr(c()),o(i,{fill:iMap.config.hover_color})),g.options.onMouseOver(g)}function u(t,i){_?(t.attr(r()),i.attr({fill:iMap.config.selected_color})):(t.attr(l()),o(i,{fill:iMap.config.text_idle_fill_color})),g.options.onMouseOut(g)}function p(){b=v.getShape(),k=m.getBg(),w=m.getText(),M=t.g(b,k,w),M.hover(function(){d(b,w)},function(){u(b,w)}),g.options.on_click_enabled===!0&&M.click(function(){_?h(b,w):f(b,w),g.options.onClick(g)}),M.dblclick(function(){g.options.onDblClick(g)})}var g=this,_=!1;i.x=parseFloat(i.x),i.y=parseFloat(i.y),i.rotate=parseInt(i.rotate),i.margin=parseInt(i.margin);var v=new iMap.Shape(t,i),m=new iMap.Text(t,i,v.getShape()),M=null,b=null,w=null,k=null;this.options=$.extend({on_click_enabled:!0,onClick:function(t){},onSelect:function(t,i){},onUnselect:function(t,i){},onMouseOver:function(t){},onMouseOut:function(t){},onDblClick:function(t){}},n),this.selectBinded=function(){if(i.bind)for(var t=0;t<i.bind.length;t++){var n=i.bind[t],o=e.getStationById(n);o&&!o.isSelected()&&o.select(!0)}},this.unselectBinded=function(){if(i.bind)for(var t=0;t<i.bind.length;t++){var n=i.bind[t],o=e.getStationById(n);o&&o.isSelected()&&o.unselect(!0)}},this.select=function(t){_||f(b,w,t)},this.unselect=function(t){_&&h(b,w,t)},this.isSelected=function(){return _},this.getData=function(){return i},this.getGroup=function(){return M},this.setDataParam=function(t,n){i[t]=n},this.getDataParam=function(t){return i[t]},this.renewData=function(){m.changeText(i),b.attr(this.isSelected()?r():l()),v.rotate(i.rotate,!0,function(){m.changeText(i)})},p(),i.selected&&this.select()},iMap.Text=function(t,i,n){function e(){var t=0,e=0,o=s.getBBox(),a=n.getBBox(),c=3;switch(i.text_side){case"top":t=a.cx-o.width/2,e=a.y-i.margin;break;case"right":t=a.x2+i.margin,e=a.cy+o.height/2-c;break;case"bottom":t=a.cx-o.width/2,e=a.y2+o.height+i.margin-c;break;case"left":t=a.x-o.width-i.margin-c,e=a.cy+o.height/2-c}return{x:t,y:e}}function o(){l=t.rect(0,0,0,0),l.attr({fill:"rgba(255, 255, 255, 0.75)",cursor:"pointer"})}function a(){var t=s.getBBox(),i=t.x-f,n=t.y-h,e=t.width+2*f,o=t.height+2*h;l.attr({x:i,y:n,width:e,height:o})}function c(){o(),s=Snap("svg").multitext(0,0,i.name),s.attr({fontSize:15,cursor:"pointer"}),r.changeText(i)}var r=this,s=null,l=null,f=2,h=0;this.getText=function(){return s},this.getBg=function(){return l},this.changeText=function(t){var i=e();s.transform("t"+i.x+","+i.y),a()},c()};
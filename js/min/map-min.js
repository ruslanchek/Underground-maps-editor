var config={text_idle_fill_color:"rgba(0, 0, 0, 1)",shape_idle_fill_color:"rgba(0, 0, 0, 0)",selected_color:"rgba(240, 0, 0, 1)",hover_color:"rgba(200, 0, 0, 1)",hover_selected_color:"rgba(220, 0, 0, 1)",bar_width:7,bar_height:7,bar_width_selected:7,bar_height_selected:7,end_width:19,end_height:7,end_width_selected:19,end_height_selected:7,circle_radius:7,circle_stroke_width:5,circle_stroke_width_selected:5},SText=function(t,e,i){function o(){var t=0,o=0,n=a.getBBox(),c=i.getBBox(),r=3;switch(e.text_side){case"top":t=c.cx-n.width/2+r,o=c.y-r-e.margin;break;case"right":t=c.x2+r+e.margin,o=c.cy+n.height/4;break;case"bottom":t=c.cx-n.width/2+r,o=c.y2+n.height-r+e.margin;break;case"left":t=c.x-n.width+3*r-e.margin,o=c.cy+n.height/4}return{x:t,y:o}}function n(){s=t.rect(0,0,0,0),s.attr({fill:"rgba(255, 255, 255, 0.75)",cursor:"pointer"})}function c(){var t=a.getBBox(),e=t.x-h,i=t.y-f,o=t.width+2*h,n=t.height+2*f;s.attr({x:e,y:i,width:o,height:n})}function r(){n(),a=t.text(0,0,e.name);var i=o();a.attr({x:i.x,y:i.y,fontSize:14,cursor:"pointer"}),c()}if(this.empty=!1,!e.name)return void(this.empty=!0);var l=this,a=null,s=null,h=2,f=0;this.getText=function(){return a},this.getBg=function(){return s},r()},SShape=function(t,e){function i(){var i=t.circle(e.x,e.y,config.circle_radius);return i.attr({fill:config.shape_idle_fill_color,stroke:e.color,strokeWidth:config.circle_stroke_width,cursor:"pointer"}),i}function o(){var i=t.rect(e.x,e.y,config.bar_width,config.bar_height);i.attr({fill:e.color,cursor:"pointer"});var o=(new Snap.Matrix).rotate(e.rotate,e.x+2,e.y+2);return i.transform(o),i}function n(){var i=t.rect(e.x,e.y,config.end_width,config.end_height);return i.attr({fill:e.color,cursor:"pointer"}),i}function c(){switch(e.type){case"circle":r=i();break;case"bar":r=o();break;case"end":r=n()}}var r=null;c(),this.getShape=function(){return r}},SStation=function(t,e,i,o){function n(t,e){t.attr(e)}function c(){switch(e.type){case"bar":return{fill:config.selected_color,width:config.bar_width,height:config.bar_height};break;case"end":return{fill:config.hover_color,width:config.end_width,height:config.end_height};break;case"circle":return{stroke:config.hover_color}}}function r(){switch(e.type){case"bar":return{fill:config.selected_color,width:config.bar_width_selected,height:config.bar_height_selected};break;case"end":return{fill:config.selected_color,width:config.end_width_selected,height:config.end_height_selected};break;case"circle":return{stroke:config.selected_color,fill:config.selected_color,strokeWidth:config.circle_stroke_width_selected}}}function l(){switch(e.type){case"bar":return{fill:config.hover_selected_color,width:config.bar_width_selected,height:config.bar_height_selected};break;case"end":return{fill:config.hover_selected_color,width:config.end_width_selected,height:config.end_height_selected};break;case"circle":return{stroke:config.hover_selected_color,fill:config.hover_selected_color,strokeWidth:config.circle_stroke_width_selected}}}function a(){switch(e.type){case"bar":return{fill:e.color,width:config.bar_width,height:config.bar_height};break;case"end":return{fill:e.color,width:config.end_width,height:config.end_height};break;case"circle":return{stroke:e.color,fill:config.shape_idle_fill_color,strokeWidth:config.circle_stroke_width}}}function s(t,e){g=!0,t.attr(r()),n(e,{fill:config.selected_color}),_.selectBinded(),_.options.onSelect(_)}function h(t,e){g=!1,t.attr(a()),n(e,{fill:config.text_idle_fill_color}),_.unselectBinded(),_.options.onUnselect(_)}function f(t,e){g?(t.attr(l()),e.attr({fill:config.hover_selected_color})):(t.attr(c()),n(e,{fill:config.hover_color})),_.options.onMouseOver(_)}function d(t,e){g?(t.attr(r()),e.attr({fill:config.selected_color})):(t.attr(a()),n(e,{fill:config.text_idle_fill_color})),_.options.onMouseOut(_)}function u(){b=p.getShape(),m.empty?w=t.g(b):(k=m.getBg(),v=m.getText(),w=t.g(b,k,v)),w.hover(function(){f(b,v)},function(){d(b,v)}),w.click(function(){g?h(b,v):s(b,v),_.options.onClick(_)})}var _=this,g=!1;e.x=parseFloat(e.x),e.y=parseFloat(e.y),e.width=parseInt(e.width),e.stroke_width=parseInt(e.stroke_width),e.rotate=parseInt(e.rotate),e.margin=parseInt(e.margin);var p=new SShape(t,e),m=new SText(t,e,p.getShape()),w=null,b=null,v=null,k=null;this.options=$.extend({onClick:function(t){},onSelect:function(t){},onUnselect:function(t){},onMouseOver:function(t){},onMouseOut:function(t){}},i),this.selectBinded=function(){if(e.bind)for(var t=0;t<e.bind.length;t++){var i=e.bind[t],n=o.getStationById(i);n&&!n.isSelected()&&n.select()}},this.unselectBinded=function(){if(e.bind)for(var t=0;t<e.bind.length;t++){var i=e.bind[t],n=o.getStationById(i);n&&n.isSelected()&&n.unselect()}},this.select=function(){g||s(b,v)},this.unselect=function(){g&&h(b,v)},this.isSelected=function(){return g},this.getData=function(){return e},u()},SMap=function(t){function e(){r.options.onLoad()}function i(){s=Snap(r.options.selector),Snap.load(r.options.map_svg,function(t){s.append(t),c(function(){s.zpd({zoom:!1,pan:!0,drag:!1}),o(function(){e()})})})}function o(t){t&&t()}function n(t){l.push(new SStation(s,t,{onClick:function(t){},onMouseOver:function(t){},onMouseOut:function(t){}},r))}function c(t){$.ajax({url:r.options.data_url,type:"get",dataType:"json",success:function(e){for(var i=0;i<e.length;i++)n(e[i]);t&&t()}})}var r=this,l=[];this.options=$.extend({selector:"",map_svg:"",data_url:"",min_zoom:.75,max_zoom:1,zoom_animation_time:500,onLoad:function(){}},t);var a=$(this.options.selector),s=null;this.zoomOut=function(t){s.zoomTo(this.options.max_zoom,t?0:this.options.zoom_animation_time,mina.easeinout)},this.zoomIn=function(t){s.zoomTo(this.options.min_zoom,t?0:this.options.zoom_animation_time,mina.easeinout)},this.getStations=function(){return l},this.getStationById=function(t){for(var e=0;e<l.length;e++){var i=l[e];if(i.getData().id==t)return i}},this.init=function(){i()}};$(function(){m=new SMap({selector:"#map",map_svg:"img/moscow.svg",data_url:"moscow.json",min_zoom:.68}),m.init(),$(".zoomer").on("click",function(t){t.preventDefault(),$(this).hasClass("active")?($(this).removeClass("active"),m.zoomIn()):($(this).addClass("active"),m.zoomOut())})});
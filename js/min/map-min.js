var config={shape_idle_fill_color:"rgba(0, 0, 0, 0)",selected_color:"rgba(245, 0, 0, 1)",hover_color:"rgba(195, 0, 0, 1)",hover_selected_color:"rgba(230, 0, 0, 1)",text_idle_fill_color:"rgba(0, 0, 0, 1)",bar_width:7,bar_height:7,bar_width_selected:7,bar_height_selected:7,end_width:19,end_height:7,end_width_selected:19,end_height_selected:7,circle_radius:7,circle_stroke_width:5,circle_stroke_width_selected:5},SText=function(t,e,o){function i(){var t=0,i=0,n=l.getBBox(),r=o.getBBox(),c=3;switch(e.text_side){case"top":t=r.cx-n.width/2+c,i=r.y-c-e.margin;break;case"right":t=r.x2+c+e.margin,i=r.cy+n.height/4;break;case"bottom":t=r.cx-n.width/2+c,i=r.y2+n.height-c+e.margin;break;case"left":t=r.x-n.width+3*c-e.margin,i=r.cy+n.height/4}return{x:t,y:i}}function n(){s=t.rect(0,0,0,0),s.attr({fill:"rgba(255, 255, 255, 0.75)",cursor:"pointer"})}function r(){var t=l.getBBox(),e=t.x-h,o=t.y-f,i=t.width+2*h,n=t.height+2*f;s.attr({x:e,y:o,width:i,height:n})}function c(){n(),l=t.text(0,0,e.name);var o=i();l.attr({x:o.x,y:o.y,fontSize:14,cursor:"pointer"}),r()}var a=this,l=null,s=null,h=2,f=0;this.getText=function(){return l},this.getBg=function(){return s},c()},SShape=function(t,e){function o(){var o=t.circle(e.x,e.y,config.circle_radius);return o.attr({fill:config.shape_idle_fill_color,stroke:e.color,strokeWidth:config.circle_stroke_width,cursor:"pointer"}),o}function i(){var o=t.rect(e.x,e.y,config.bar_width,config.bar_height);o.attr({fill:e.color,cursor:"pointer"});var i=(new Snap.Matrix).rotate(e.rotate,e.x+2,e.y+2);return o.transform(i),o}function n(){var o=t.rect(e.x,e.y,config.end_width,config.end_height);return o.attr({fill:e.color,cursor:"pointer"}),o}function r(){switch(e.type){case"circle":c=o();break;case"bar":c=i();break;case"end":c=n()}}var c=null;r(),this.getShape=function(){return c}},SStation=function(t,e,o){function i(){switch(e.type){case"bar":return{fill:config.selected_color,width:config.bar_width,height:config.bar_height};break;case"end":return{fill:config.hover_color,width:config.end_width,height:config.end_height};break;case"circle":return{stroke:config.hover_color}}}function n(){switch(e.type){case"bar":return{fill:config.selected_color,width:config.bar_width_selected,height:config.bar_height_selected};break;case"end":return{fill:config.selected_color,width:config.end_width_selected,height:config.end_height_selected};break;case"circle":return{stroke:config.selected_color,fill:config.selected_color,strokeWidth:config.circle_stroke_width_selected}}}function r(){switch(e.type){case"bar":return{fill:config.hover_selected_color,width:config.bar_width_selected,height:config.bar_height_selected};break;case"end":return{fill:config.hover_selected_color,width:config.end_width_selected,height:config.end_height_selected};break;case"circle":return{stroke:config.hover_selected_color,fill:config.hover_selected_color,strokeWidth:config.circle_stroke_width_selected}}}function c(){switch(e.type){case"bar":return{fill:e.color,width:config.bar_width,height:config.bar_height};break;case"end":return{fill:e.color,width:config.end_width,height:config.end_height};break;case"circle":return{stroke:e.color,fill:config.shape_idle_fill_color,strokeWidth:config.circle_stroke_width}}}function a(t,o,i){_?(_=!1,o.attr(c()),i.attr({fill:config.text_idle_fill_color})):(_=!0,o.attr(n()),i.attr({fill:config.selected_color})),f.options.onClick(t,e)}function l(t,o,n){f.options.onMouseOver(t,e),_?(o.attr(r()),n.attr({fill:config.hover_selected_color})):(o.attr(i()),n.attr({fill:config.hover_color}))}function s(t,o,i){f.options.onMouseOut(t,e),_?(o.attr(n()),i.attr({fill:config.selected_color})):(o.attr(c()),i.attr({fill:config.text_idle_fill_color}))}function h(){var e=d.getShape(),o=g.getText(),i=g.getBg();u=t.g(i,e,o),u.hover(function(t){l(t,e,o)},function(t){s(t,e,o)}),u.click(function(t){a(t,e,o)})}var f=this,_=!1;e.x=parseFloat(e.x),e.y=parseFloat(e.y),e.width=parseInt(e.width),e.stroke_width=parseInt(e.stroke_width),e.rotate=parseInt(e.rotate),e.margin=parseInt(e.margin);var d=new SShape(t,e),g=new SText(t,e,d.getShape()),u=null;this.options=$.extend({onClick:function(t,e){},onMouseOver:function(t,e){},onMouseOut:function(t,e){}},o),h()},SMap=function(t){function e(){c.options.onLoad()}function o(){f=Snap(c.options.selector),Snap.load(c.options.map_svg,function(t){f.append(t),n(function(){f.zpd({zoom:!1,pan:!0,drag:!1}),r(function(){e()})})})}function i(t){a.push(new SStation(f,t))}function n(t){$.ajax({url:c.options.data_url,type:"get",dataType:"json",success:function(e){for(var o=0;o<e.length;o++)i(e[o]);t&&t()}})}function r(t){t&&t()}var c=this,a=[];this.options=$.extend({selector:"",map_svg:"",data_url:"",min_zoom:.75,max_zoom:1,zoom_animation_time:500,onLoad:function(){}},t);var l=$(this.options.selector),s=l.width(),h=l.height(),f=null;this.zoomOut=function(t){f.zoomTo(this.options.max_zoom,t?0:this.options.zoom_animation_time,mina.easeinout)},this.zoomIn=function(t){f.zoomTo(this.options.min_zoom,t?0:this.options.zoom_animation_time,mina.easeinout)},this.init=function(){o()}};$(function(){var t=new SMap({selector:"#map",map_svg:"img/moscow.svg",data_url:"moscow.json",min_zoom:.68});t.init(),$(".zoomer").on("click",function(e){e.preventDefault(),$(this).hasClass("active")?($(this).removeClass("active"),t.zoomIn()):($(this).addClass("active"),t.zoomOut())})});